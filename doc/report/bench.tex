\documentclass{article}
\title{Benchmarking CASA Image Cube Access}
\author{Peter Teuben}
\date{\today}
\begin{document}
\maketitle

% \section*{Benchmark}

We conducted a modest benchmark to gain some insight in image
I/O patterns for a few packages easily accessible to us: CASA,
MIRIAD and NEMO. The first order goal is to understand if the
current CASA data access model is reasonably fast for general
access.
MIRIAD is the standard analysis package for
CARMA; NEMO is a stellar dynamics software tookbox which is
partially maintained by Peter Teuben. For these tests, we
used version 4.1.0 (r24668) of CASA. These test utilize 3-dimensional cubes
because they are the most common in ALMA data.

CASA uses a tiled storage manager, which in principle
can be tuned to optimize access speed for the specific
cube dimensions.  Current, CASA does not actively tune
the tiling so these tests are done with CASA's standard tiling.
MIRIAD has a traditional row based access; it rarely
uses memory to store full planes or cubes. NEMO is completely
memory based, and stores data either row or column based
(by default in double precision).

Three datasets of 4GB ($10^9$ pixels)\footnote{4GB also happens to
be a good test to confirm there are no 32bit code issues left}
in size were used:
a 1024x1024x1024 true data ``cube'',
a 4096x4096x64 3-D ``slab'' and a 128x128x65536 3-D ``stick''.
Four operations were considered:  reading from fits
into the package native format,
a simple rms/mean statistics that visits the whole cube in the
most efficient way, adding two cubes, and finally
a Hanning smooth in X, Y and Z, where possible.  For MIRIAD
the Hanning smooth test had to be skipped in X and Y, unless
an additional {\tt reorder} step would be allowed, which we did
not consider in this version of the benchmark.
It should be added that a true Hanning in MIRIAD
is the slowest possible operation, since the data is stored
row-wise.

The tests were performed on a 3.6GHz i7-3820 CPU with 64 GB of memory 
utilizing 1 core.  Disk I/O (using {\tt hdparm -t} was measured at
800 MB/sec. Times reported are the sum of user and system time, averaged
over 3 runs, except when caching was apparent, only the first instance 
was reported.

\begin{table}[h]
\begin{center}
\begin{tabular}{|l || r r r || r r r || r r r |}
\hline
        & \multicolumn{3}{|c|}  { Cube } 
        &  \multicolumn{3}{|c|} { Slab }
        &  \multicolumn{3}{|c|} { Stick } \\
        & \multicolumn{3}{|c|}  { 1024x1024x1024 }
        &  \multicolumn{3}{|c|} { 4096x4096x64 } 
        &  \multicolumn{3}{|c|} { 128x128x65536 } \\
        & CASA  & MIRIAD & NEMO    & CASA  & MIRIAD & NEMO  & CASA & MIRIAD & NEMO \\
%        & C     & M    & N         & C     & M     & N      & C    & M    & N \\
\hline
FITS    & 16.6 & 13.5  &  16.0  & 13.7    & 11.5   & 14.1  & 25.2  &  14.7  & 18.4 \\
STATS   & 17.0 & 11.3  &  10.4  & 17.1    & 11.1   &  9.4  & 17.1  &  11.1  & 10.1 \\
MATH    & 8.5  &  7.7  &  35.7  &  8.3    & 7.8    & 33.5  &  7.9  &  8.6   & 35.5  \\
HAN-x   & 8.8  &       &   8.9  &  6.0    &        &  9.0  & 27.2  &        &  9.0 \\
HAN-y   & 9.8  &       &  17.3  &  8.7    &        & 45.8  & 28.6  &        &  9.8 \\
HAN-z   & 14.6 &  93.0 & 106.5  & 52.9    & 100.0  & 44.7  &  9.0  &  130.0 & 46.2 \\
\hline 
\end{tabular}
\end{center}
\caption{Comparing I/O access in a ``cube'', ``slab'' and ``stick'' like dataset. 
Times reported
are the sum of user and system time, in seconds, on a 3.6GHz i7-3820 CPU.
Columns designated are for C=CASA  M=MIRIAD N=NEMO(float).}
\end{table}


The tiled access in CASA performs well for true cubes, independent of
the access direction.  But does poorly in a slab like cube, but
outperforms anything else for a stick like cube. The odd performance
of the MATH case for NEMO is because of an awkward interpreter used.

\end{document}
