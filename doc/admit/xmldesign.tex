%$Id$
\documentclass{report}
\title{ADMIT XML Design}
\author{Marc Pound, Peter Teuben}
\date{\today}
\begin{document}
\maketitle

\section{Overview}

For each science project ADMIT runs a series of ``admit tasks'', which
are essentially beefed up CASA tools/tasks, and produce Basic Data
Products (BDP).  ADMIT provides a wrapper around these tasks
(CASA tasks, but with some extra baggage to make it fit within the pipeline
and have a persistent state within the pipeline as well for re-use by
the user later on).

Once users have downloaded the data, they can preview the work the pipeline
has created for them. They will also be able to re-run
selected portions of the ADMIT pipeline from either the (casapy)
commandline, or a (casa) GUI, and compare and improve upon the
pipeline produced results. ADMIT produces Basic Data Product (BDP), in
addition to the existing Alma Data Products (ADP)\footnote{Examples of
ADP's in a project are the Raw Visibility Data (in ASDM format) and
the Science Data Cubes (in FITS format) for each source and each
band}

Meta-projects can be defined, and ADMIT be used to steer and control
how to run on individual projects and sources, after which selected
results can be datamined 

\subsection{Basic Data Products}

Only the smaller portions of the BDP (Basic Data Products) can be found
in the admit.zip file, others will have to be recreated through the
ADMIT pipeline. Examples of BDP (both exported and recreatable) are

\begin{enumerate}
\item
Summary of the meta data, as much as is needed for the ADMIT pipeline.
\item
Cube Statistics: a simple table of min, max, mean, median etc. for each plane
\item
Line List: a list of all lines detected in a band, but there is also a bandmerged version
\item
Line Cube: foreach line from the Line List there will be a data cube extracted from the
band cube.  (the cube itself will not be exported)
\item
Mom0,1,2: simple moment maps  (these will be exported as JPEG)
\item
PeakSpectrum: for each line cube a spectrum through the cube at the peak in Mom0 is given
\item
Feature List: for each line cube a list of features (clumps, blobs, etc.) is saved in tabular format.
\item 
Overlap Integral: combining all Mom0 maps, an overlap integral map is created.

\end{enumerate}

\subsection{Meta Project Data Mining}

One of the novel ways in which users can interact with ADMIT is the meta project.
A series of projects (really project/source combinations)
can be selected for further work and data mined.



setup a meta-project (MP) based on either all P's that have valid azip's, or use 
a complex query that goes into each Project and either selects or deselects.
Manual creation is perfectly ok as well :-)

We need some use cases here. 
    - select based on a specific line (L) present
    - select based on a source name
    - select based on a previously set user supplied keyword (on what level?)

MP needs to have some record how it was created
  
Re-run one more more MPs based on a procedure established in one P ?

Data Mining operations in MPs?

- acumulate things you did in a P into an MP (e.g. clump spectrum to gain statistics)

- extract things from a P (or do we need to distinguish P from P/S or P/S/B or P/S/L)
and stuff them in python data structures for any plotting or linked data analysis/vis
MatplotLib (?Should we use GLUE as our standard example to visualize?)


\section{Guiding Principles}
The XML structure should be complete enough to capture proposed use cases,
but not so restrictive that it precludes future use cases. To that end, a
limited hierarchy is desirable, with basic ``objects" that can be contained
within one another but are not {\it defined} within one another.  However, we
do need to follow what we understand to be the basic hierarchical structure
of the archive produces Project$\rightarrow$Source$\rightarrow$Bands.
We argue it is not necessary to expose the Project container to
the user, e.g. in the case of a data mining operation that spans multiple
projects. The science is in the sources not the project. To that end, the
Project container is extremely thin: it contains only the identificiation
code, everything else is inside source containers.

\subsection{Elements vs. Attributes}.  
We follow the principal that data go in elements and metadata about
elements go in attributes.   Thus rather than

\begin{verbatim}
<project name="c0123">  
\end{verbatim}

we use 

\begin{verbatim}
<project>
<name>c0123</name>
\end{verbatim}

However, project name is an example of element we may want to be read-only
(ADMIT user cannot change it), so there we use an attribute.

\begin{verbatim}
<project>
  <name readonly="true">c0123</name>
\end{verbatim}

\subsection{Detailed Structure}

\begin{verbatim}

project
    source
        band
        line 
        image
        spectrum
        task
        procedure
    


<Project>
<source>
    <name></name>
    <coordinate>
        <crvalN>
        <ctypeN>
    </coordinate>
    <equinox></equinox>
    <type> [galactic, extragalactic, etc]
</source>

<image>
   <name>
   <type> [data or thumbnail]
   <description> [moment zero, moment one, spectral cutout, full cube. ??] 
% sources in this image
   <source>A</source> % must match source names in <source> tags.
   <naxisN>
   <crpixN>
   <crvalN>
   <ctypeN>
   <statistics>
%% Can have multiple areas over which statistics are measured.
%% NB: Does casa multiple boxes print two stats or one?
        <region>
            <number>
            <blc>
            <trc>
            <startchannel>
            <endchannel>
            <mean>
            <max>
            <rms>
            <clip>
        </region>
   </statistics>
</image>
<spectrum>
   <sourcename>
   <start freq>
   <start vel>
   <statistics> </statistics> %% as above
   <channel>value</channel>
   <channel>value</channel>
   <channel>value</channel>
   <channel>value</channel> 
  %% or better as a table?
</spectrum>

%% Just rely on CASA for this. Note TASK.last files are keyword=value, not XML!
<task>
  <name>
  <parameters>
    <keyword>value</keyword>
    <keyword2>value2</keyword2>
    ...etc
  </parameters>
  <date> date/time of last run? </date>
</task>

\end{verbatim}

\subsection{XML Overview}
Without the cumbersome XML syntax, but simply using indentation, this is an overview
of the XML tree that admit.zip will contain

\newpage

\footnotesize
\begin{verbatim}

 Project(name)[NP]
    Summary
       <atask name=at_summary>
    Source(name)[NS]
       Summary
           ra,dec,vlsr,...
           <atask name=at_summary>
       Band(number)[NB]
           URI:im
           Summary
              FreqMin,FreqMax,FreqStep
           CubeStats
              VoTable:tab
              <atask name=at_cubestats>
              <dep>
              File:im
           PosVelSlice
              URI:im
              file:jpg
              <atask name=at_pv>
           LineList
              VoTable:tab
              <atask name=at_band2line>
              <dep>
                CubeStats
        LineList
           votable:tab
           <atask name=at_linemerge>
           <dep>
             band[NB].LineList
        Line(name)[NL]
           LineCube
              URI:im
              <atask name=at_reframe>
              <dep>
                LineList
           RMS (since cubestats can differ per channel)
           Mom0
              URI:im
              file:jpg
              <atask name=at_moment>
              <dep>
                LineCube
           Mom1
           Mom2
           PeakSpectrum
              VoTable:tab
              <summary>
                Peak, RMS, V0, FWHM, SdV
              <atask name=at_spectrum>
              <dep>
                LineCube
           IntegratedSpectrum
              VoTable:tab
              <summary>
                Peak, RMS, V0, FWHM, SdV
              <atask name=at_spectrum>
              <dep>
                LineCube


\end{verbatim}
\normalsize

\newpage



XML style?

\footnotesize
\begin{verbatim}
<PeakSpectrum type="spectrum">
<Moment0 type="image">
\end{verbatim}
\normalsize
vs.

\footnotesize
\begin{verbatim}
<image name="peakspectrum">
<image name="moment0">
\end{verbatim}
\normalsize

vs.

\footnotesize
\begin{verbatim}

<PeakSpectrum type="BDP"> 
  <image URI=...> 
  <atask ...>
  <dependancy ...>
</PeakSpectrum>

\end{verbatim}
\normalsize



The dependancies might even fit in a Makefile, viz. (using the P/S/B and P/S/L hierarchy)


\footnotesize
\begin{verbatim}

p1_s1_l1_mom0:          p1_s1_l1_linecube

p1_s1_l1_linecube:      p1_s1_linelist p1_s1_b1

p1_s1_linelist:         p1_s1_b1_linelist p1_s1_b2_linelist p1_s1_b3_linelist p1_s1_b4_linelist
                        at_linemerge

p1_s1_b1_linelist:      p1_s1_b1
                        at_band2line

p1_s1_b1:               file:im
                        at_archive(p1,s1,b1)

p1_summary:
                        at_summary
        
\end{verbatim}
\normalsize


\subsection{CASA task}

The {\tt atask} will hopefully be just a casa task, of which the XML representation
looks as follows:
\footnotesize
\begin{verbatim}
<casaxml>
    <task type="function" name="foobar" category="fumbar">
        <shortdescription>
        <description>
        <input>
	    <param>
	        <description>
	        <any>
	        <value>
        <returns>
        <example>
    </task>  
</casaxml>
\end{verbatim}
\normalsize

\section{Use Cases}

\subsection{Archive}

The first case covers the first goal for ADMIT:  produce an admit.zip from
a given project.   A project can contain a number of sources, and
for each source there will be (for ALMA) 4 image data cubes, in FITS
format.

\subsection{First Look}

The next case covers a user that has gone to his/her project on the
archive, and downloaded the admit.zip file. The ADMIT environment in
casapy will then either bring up a GUI outlining all BDP (Basic Data
products) present.

\subsection{Rerun Pipeline}

After a first look, the user may be unhappy that a certain obvious line
was not added to the line cataloge (LineList). Or may want to recreate
moment maps based on a lower clip level. In the GUI each BDP has an
interaction by which its input methods and parameters can be changed.

\subsection{Virtual Projects}

In this more advanced case, the user selects a number of sources from one
or more projects in a virtual ADMIT container. Any of the basic ADMIT procedures
can now be re-run and/or reviewed, but looped over the selected sources.
Users can write their own procedures,
and store persistent data back into {\tt admit.zip}. ADMIT has interfaces
using python to extract numbers and python arrays out of admit.zip, and thereby
allow for flexible data mining, linked data plotting etc.


\end{document}
